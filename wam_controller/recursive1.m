function x = recursive1(q,qd,tau)
DH_a = [0 0 0.045 -0.045 0 0 0];
    DH_d = [0 0 .55 0 0.3 0 0.061];
    DH_alpha = [-pi/2 pi/2 -pi/2 pi/2 -pi/2 pi/2 0];

    m = [8.3 4.8484 1.7251 2.17266212 0.35655692 0.40915886 0.07548270];
    
     
    
    com = zeros(4,7);
    com(:,1) = [0.3506e-3; 132.6795e-3; 0.6286e-3;1];
    com(:,2) = [-0.2230e-3; -21.3924e-3; 13.3754e-3;1];
    com(:,3) = [-38.7565e-3; 217.9078e-3; 0.0252e-3;1];
    com(:,4) = [0.00553408;0.00006822;0.11927695;1];
    com(:,5) = [0.00005483;0.02886286;0.00148493;1];
    com(:,6) = [-0.00005923;-0.07007252;-0.00335185;1];
    com(:,7) = [ 0.00014836;0.00007252;-0.00335185;1];
     
        
    
    I = zeros(3,3,7);
    
     I(:,:,1) = [ 95157.4294e-6,   246.1404e-6,   -95.0183e-6 ;
                   246.1404e-6, 92032.3524e-6,  -962.6725e-6 ;
                   -95.0183e-6,  -962.6725e-6, 59290.5997e-6 ];
    I(:,:,2) = [ 29326.8098e-6,   -43.3994e-6,  -129.2942e-6 ;
                   -43.3994e-6, 20781.5826e-6,  1348.6924e-6 ;
                  -129.2942e-6,  1348.6924e-6, 22807.3271e-6 ];
    I(:,:,3) = [ 56662.2970e-6, -2321.6892e-6,     8.2125e-6 ;
                 -2321.6892e-6,  3158.0509e-6,   -16.6307e-6 ;
                     8.2125e-6,   -16.6307e-6, 56806.6024e-6 ];
    I(:,:,4) = [  0.01067491,  0.00004503, -0.00135557 ;
                  0.00004503,  0.01058659, -0.00011002 ;
                 -0.00135557, -0.00011002,  0.00282036 ];
    I(:,:,5) = [  0.00037112, -0.00000008, -0.00000003 ;
                 -0.00000008,  0.00019434, -0.00001613 ;
                 -0.00000003, -0.00001613,  0.00038209 ];
    I(:,:,6) =  [  0.00054889,  0.00000019, -0.00000010 ;
                   0.00000019,  0.00023846, -0.00004430 ;
                  -0.00000010, -0.00004430,  0.00045133 ];
    I(:,:,7) = [ 0.003167342,          0,         0;       % Approximate Inertia Tensor for Schunk Gripper
                              0, 0.001128942,         0;
                              0,          0, 0.00258007;];
                          
                          
for j=1:7,
        a = DH_a(j);
        d = DH_d(j);
        alpha = DH_alpha(j);
        T(:,:,j) = getTransformDH(a, d, alpha, q(j));
end 
A = zeros(4,4,7);
A(:,:,1) = T(:,:,1);
A(:,:,2) = A(:,:,1)*T(:,:,2);
A(:,:,3) = A(:,:,2)*T(:,:,3);
A(:,:,4) = A(:,:,3)*T(:,:,4);
A(:,:,5) = A(:,:,4)*T(:,:,5);
A(:,:,6) = A(:,:,5)*T(:,:,6);
A(:,:,7) = A(:,:,6)*T(:,:,7);


M(:,:,1)= [ m(1)*I(:,:,1) , zeros(3,3);
           zeros(3,3), m(1)*eye(3)] ;
       
M(:,:,2)= [ m(2)*I(:,:,2) , zeros(3,3);
           zeros(3,3), m(2)*eye(3)] ;
       
M(:,:,3)= [ m(3)*I(:,:,3) , zeros(3,3);
           zeros(3,3), m(3)*eye(3)] ;
       
M(:,:,4)= [ m(4)*I(:,:,4) , zeros(3,3);
           zeros(3,3), m(4)*eye(3)] ;
       
M(:,:,5)= [ m(5)*I(:,:,5) , zeros(3,3);
           zeros(3,3), m(5)*eye(3)] ;
      
M(:,:,6)= [ m(6)*I(:,:,6) , zeros(3,3);
           zeros(3,3), m(6)*eye(3)] ;
      
M(:,:,7)= [ m(7)*I(:,:,7) , zeros(3,3);
           zeros(3,3), m(7)*eye(3)] ;
      
       Cd=zeros(4,7,7);
       C=zeros(3,7,7);
       Cstar=zeros(3,3,7,7);
       
       Cd(:,2,1) = com(:,1)-T(:,:,2)*com(:,2);
       C(:,2,1)= T((1:3),(1:3),1)*Cd((1:3),2,1);
       Cstar(:,:,2,1) = [0,-C(3,2,1),C(2,2,1);
                         C(3,2,1),0,-C(1,2,1);
                        -C(2,2,1),C(1,2,1),0];
       
       Cd(:,3,1) = com(:,1)-inv(A(:,:,1))*A(:,:,3)*com(:,3);
       C(:,3,1)= T((1:3),(1:3),1)*Cd((1:3),3,1);
       Cstar(:,:,3,1) = [0,-C(3,3,1),C(2,3,1);
                         C(3,3,1),0,-C(1,3,1);
                        -C(2,3,1),C(1,3,1),0];
       
       Cd(:,4,1) = com(:,1)-inv(A(:,:,1))*A(:,:,4)*com(:,4);
       C(:,4,1)= T((1:3),(1:3),1)*Cd((1:3),4,1);
       Cstar(:,:,4,1) = [0,-C(3,4,1),C(2,4,1);
                         C(3,4,1),0,-C(1,4,1);
                        -C(2,4,1),C(1,4,1),0];
  
       Cd(:,5,1) = com(:,1)-inv(A(:,:,1))*A(:,:,5)*com(:,5);
       C(:,5,1)= T((1:3),(1:3),1)*Cd((1:3),5,1);
       Cstar(:,:,5,1) = [0,-C(3,5,1),C(2,5,1);
                         C(3,5,1),0,-C(1,5,1);
                        -C(2,5,1),C(1,5,1),0];
       
       Cd(:,6,1) = com(:,1)-inv(A(:,:,1))*A(:,:,6)*com(:,6);
       C(:,6,1)= T((1:3),(1:3),1)*Cd((1:3),6,1);
       Cstar(:,:,6,1) = [0,-C(3,6,1),C(2,6,1);
                         C(3,6,1),0,-C(1,6,1);
                        -C(2,6,1),C(1,6,1),0];
       
       Cd(:,7,1) = com(:,1)-inv(A(:,:,1))*A(:,:,7)*com(:,7);
       C(:,7,1)= T((1:3),(1:3),1)*Cd((1:3),7,1);
       Cstar(:,:,7,1) = [0,-C(3,7,1),C(2,7,1);
                         C(3,7,1),0,-C(1,7,1);
                        -C(2,7,1),C(1,7,1),0];
       
       
       
       Cd(:,3,2)= com(:,2)-T(:,:,3)*com(:,3);
       C(:,3,2)= T((1:3),(1:3),2)*Cd((1:3),3,2);
       Cstar(:,:,3,2) = [0,-C(3,3,2),C(2,3,2);
                         C(3,3,2),0,-C(1,3,2);
                        -C(2,3,2),C(1,3,2),0];
       Cd(:,4,2)= com(:,2)-inv(A(:,:,2))*A(:,:,4)*com(:,4);
       C(:,4,2)= T((1:3),(1:3),2)*Cd((1:3),4,2);
       Cstar(:,:,4,2) = [0,-C(3,4,2),C(2,4,2);
                         C(3,4,2),0,-C(1,4,2);
                        -C(2,4,2),C(1,4,2),0];
                    
       Cd(:,5,2)= com(:,2)-inv(A(:,:,2))*A(:,:,5)*com(:,5);
       C(:,5,2)= T((1:3),(1:3),2)*Cd((1:3),5,2);
       Cstar(:,:,5,2) = [0,-C(3,5,2),C(2,5,2);
                         C(3,5,2),0,-C(1,5,2);
                        -C(2,5,2),C(1,5,2),0];
       
       Cd(:,6,2)= com(:,2)-inv(A(:,:,2))*A(:,:,6)*com(:,6);
       C(:,6,2)= T((1:3),(1:3),2)*Cd((1:3),6,2);
       Cstar(:,:,6,2) = [0,-C(3,6,2),C(2,6,2);
                         C(3,6,2),0,-C(1,6,2);
                        -C(2,6,2),C(1,6,2),0];  
       
       Cd(:,7,2)= com(:,2)-inv(A(:,:,2))*A(:,:,7)*com(:,7);
       C(:,7,2)= T((1:3),(1:3),2)*Cd((1:3),7,2);
       Cstar(:,:,7,2) = [0,-C(3,7,2),C(2,7,2);
                         C(3,7,2),0,-C(1,7,2);
                        -C(2,7,2),C(1,7,2),0];        
       
       Cd(:,4,3)= com(:,3)-T(:,:,4)*com(:,4);
       C(:,4,3)= T((1:3),(1:3),3)*Cd((1:3),4,3);
       Cstar(:,:,4,3) = [0,-C(3,4,3),C(2,4,3);
                         C(3,4,3),0,-C(1,4,3);
                        -C(2,4,3),C(1,4,3),0]; 
                    
        Cd(:,5,3)= com(:,3)-inv(A(:,:,3))*A(:,:,5)*com(:,5);
       C(:,5,3)= T((1:3),(1:3),3)*Cd((1:3),5,3);
       Cstar(:,:,5,3) = [0,-C(3,5,3),C(2,5,3);
                         C(3,5,3),0,-C(1,5,3);
                        -C(2,5,3),C(1,5,3),0]; 
                    
         Cd(:,6,3)= com(:,3)-inv(A(:,:,3))*A(:,:,6)*com(:,6);
       C(:,6,3)= T((1:3),(1:3),3)*Cd((1:3),6,3);
       Cstar(:,:,6,3) = [0,-C(3,6,3),C(2,6,3);
                         C(3,6,3),0,-C(1,6,3);
                        -C(2,6,3),C(1,6,3),0]; 
       
         Cd(:,7,3)= com(:,3)-inv(A(:,:,3))*A(:,:,7)*com(:,7);
       C(:,7,3)= T((1:3),(1:3),3)*Cd((1:3),7,3);
       Cstar(:,:,7,3) = [0,-C(3,7,3),C(2,7,3);
                         C(3,7,3),0,-C(1,7,3);
                        -C(2,7,3),C(1,7,3),0];   
                    
       Cd(:,5,4)= com(:,4)-T(:,:,5)*com(:,5);
       C(:,5,4)= T((1:3),(1:3),4)*Cd((1:3),5,4);
       Cstar(:,:,5,4) = [0,-C(3,5,4),C(2,5,4);
                         C(3,5,4),0,-C(1,5,4);
                        -C(2,5,4),C(1,5,4),0];
                    
                    
      Cd(:,6,4)= com(:,4)-inv(A(:,:,4))*A(:,:,6)*com(:,6);
       C(:,6,4)= T((1:3),(1:3),4)*Cd((1:3),6,4);
       Cstar(:,:,6,4) = [0,-C(3,6,4),C(2,6,4);
                         C(3,6,4),0,-C(1,6,4);
                        -C(2,6,4),C(1,6,4),0];
                    
       Cd(:,7,4)= com(:,4)-inv(A(:,:,4))*A(:,:,7)*com(:,7);
       C(:,7,4)= T((1:3),(1:3),4)*Cd((1:3),7,4);
       Cstar(:,:,7,4) = [0,-C(3,7,4),C(2,7,4);
                         C(3,7,4),0,-C(1,7,4);
                        -C(2,7,4),C(1,7,4),0];
                    
       Cd(:,6,5)= com(:,5)-T(:,:,6)*com(:,6);
       C(:,6,5)= T((1:3),(1:3),5)*Cd((1:3),6,5);
       Cstar(:,:,6,5) = [0,-C(3,6,5),C(2,6,5);
                         C(3,6,5),0,-C(1,6,5);
                        -C(2,6,5),C(1,6,5),0];
       
       Cd(:,7,5)= com(:,5)-inv(A(:,:,5))*A(:,:,7)*com(:,7);
       C(:,7,5)= T((1:3),(1:3),5)*Cd((1:3),7,5);
       Cstar(:,:,7,5) = [0,-C(3,7,5),C(2,7,5);
                         C(3,7,5),0,-C(1,7,5);
                        -C(2,7,5),C(1,7,5),0];           
       
       Cd(:,7,6)= com(:,6)-T(:,:,7)*com(:,7);
       C(:,7,6)= T((1:3),(1:3),6)*Cd((1:3),7,6);
       Cstar(:,:,7,6) = [0,-C(3,7,6),C(2,7,6);
                         C(3,7,6),0,-C(1,7,6);
                        -C(2,7,6),C(1,7,6),0];
                    
       B=zeros(6,6,7,7);
B(:,:,2,1)= [eye(3),zeros(3,3);
         Cstar(:,:,2,1), eye(3)];
         
B(:,:,3,1)=[eye(3),zeros(3,3);
         Cstar(:,:,3,1), eye(3)];
B(:,:,3,2)= [eye(3),zeros(3,3);
         Cstar(:,:,3,2), eye(3)];
B(:,:,4,1)=[eye(3),zeros(3,3);
         Cstar(:,:,4,1), eye(3)];
B(:,:,4,2)=[eye(3),zeros(3,3);
         Cstar(:,:,4,2), eye(3)];
B(:,:,4,3)=[eye(3),zeros(3,3);
         Cstar(:,:,4,3), eye(3)];
B(:,:,5,1)=[eye(3),zeros(3,3);
         Cstar(:,:,5,1), eye(3)];
B(:,:,5,2)=[eye(3),zeros(3,3);
         Cstar(:,:,5,2), eye(3)];
B(:,:,5,3)=[eye(3),zeros(3,3);
         Cstar(:,:,5,3), eye(3)];
B(:,:,5,4)=[eye(3),zeros(3,3);
         Cstar(:,:,5,4), eye(3)];
B(:,:,6,1)=[eye(3),zeros(3,3);
         Cstar(:,:,6,1), eye(3)];
B(:,:,6,2)=[eye(3),zeros(3,3);
         Cstar(:,:,6,2), eye(3)];
B(:,:,6,3)=[eye(3),zeros(3,3);
         Cstar(:,:,6,3), eye(3)];
B(:,:,6,4)=[eye(3),zeros(3,3);
         Cstar(:,:,6,4), eye(3)];
B(:,:,6,5)=[eye(3),zeros(3,3);
         Cstar(:,:,6,5), eye(3)];

B(:,:,7,1)=[eye(3),zeros(3,3);
         Cstar(:,:,7,1), eye(3)];
B(:,:,7,2)=[eye(3),zeros(3,3);
         Cstar(:,:,7,2), eye(3)];
B(:,:,7,3)=[eye(3),zeros(3,3);
         Cstar(:,:,7,3), eye(3)];
B(:,:,7,4)=[eye(3),zeros(3,3);
         Cstar(:,:,7,4), eye(3)];
B(:,:,7,5)=[eye(3),zeros(3,3);
         Cstar(:,:,7,5), eye(3)];
B(:,:,7,6)=[eye(3),zeros(3,3);
         Cstar(:,:,7,6), eye(3)];



d=zeros(4,7);
d(:,1)=T(:,:,1)*com(:,1);
d(:,2)=T(:,:,2)*com(:,2);
d(:,3)=T(:,:,3)*com(:,3);
d(:,4)=T(:,:,4)*com(:,4);
d(:,5)=T(:,:,5)*com(:,5);
d(:,6)=T(:,:,6)*com(:,6);
d(:,7)=T(:,:,7)*com(:,7);

p(:,1)= [ [0;0;1]; cross([0;0;1],d((1:3),1))];
p(:,2)= [ [0;0;1]; cross([0;0;1],d((1:3),2))];
p(:,3)= [ [0;0;1]; cross([0;0;1],d((1:3),3))];
p(:,4)= [ [0;0;1]; cross([0;0;1],d((1:3),4))];
p(:,5)= [ [0;0;1]; cross([0;0;1],d((1:3),5))];
p(:,6)= [ [0;0;1]; cross([0;0;1],d((1:3),6))];
p(:,7)= [ [0;0;1]; cross([0;0;1],d((1:3),7))];

Nd=[p(:,1),zeros(6,1),zeros(6,1),zeros(6,1),zeros(6,1),zeros(6,1),zeros(6,1);
    zeros(6,1),p(:,2),zeros(6,1),zeros(6,1),zeros(6,1),zeros(6,1),zeros(6,1);
    zeros(6,1),zeros(6,1),p(:,3),zeros(6,1),zeros(6,1),zeros(6,1),zeros(6,1);
    zeros(6,1),zeros(6,1),zeros(6,1),p(:,4),zeros(6,1),zeros(6,1),zeros(6,1);
    zeros(6,1),zeros(6,1),zeros(6,1),zeros(6,1),p(:,5),zeros(6,1),zeros(6,1);
    zeros(6,1),zeros(6,1),zeros(6,1),zeros(6,1),zeros(6,1),p(:,6),zeros(6,1);
    zeros(6,1),zeros(6,1),zeros(6,1),zeros(6,1),zeros(6,1),zeros(6,1),p(:,7);];

Nl=[eye(6),zeros(6,6),zeros(6,6),zeros(6,6),zeros(6,6),zeros(6,6),zeros(6,6);
    B(:,:,2,1),eye(6),zeros(6,6),zeros(6,6),zeros(6,6),zeros(6,6),zeros(6,6);
    B(:,:,3,1),B(:,:,3,2),eye(6),zeros(6,6),zeros(6,6),zeros(6,6),zeros(6,6);
    B(:,:,4,1),B(:,:,4,2),B(:,:,4,3),eye(6),zeros(6,6),zeros(6,6),zeros(6,6);
    B(:,:,5,1),B(:,:,5,2),B(:,:,5,3),B(:,:,5,4),eye(6),zeros(6,6),zeros(6,6);
    B(:,:,6,1),B(:,:,6,2),B(:,:,6,3),B(:,:,6,4),B(:,:,6,5),eye(6),zeros(6,6);
    B(:,:,7,1),B(:,:,7,2),B(:,:,7,3),B(:,:,7,4),B(:,:,7,5),B(:,:,7,6),eye(6);];

Mt=transpose(Nl)*M*Nl;
D=transpose(Nd)*M*Nd;






























xd = [qd;-inv(D)*zeros(7,1)] + [zeros(7,7);inv(D)]*tau;
x= xd*0.002 + [q;qd];
end


function T = getTransformDH(a,d,alpha,q)
    ct = cos(q);
    st = sin(q);
    cb = cos(alpha);
    sb = sin(alpha);
    
    T = [ ct, -st*cb,  st*sb, a*ct;
          st,  ct*cb, -ct*sb, a*st;
          0, sb, cb, d;
          0, 0, 0, 1 ];            
   end       

