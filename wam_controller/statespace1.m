function x = statespace1(q,qd,tau)
DH_a = [0 0 0.045 -0.045 0 0 0];
    DH_d = [0 0 .55 0 0.3 0 0.061];
    DH_alpha = [-pi/2 pi/2 -pi/2 pi/2 -pi/2 pi/2 0];

    m = [8.3936 4.8487 1.7251 2.0824 0.3067 0.4278 0.0057];
    
 I(:,:,1) = [ 242919.8516e-6,  -636.5542e-6,  93.16877e-6 ;
                 -636.5542e-6  , 92036.7003e-6,  -262.6542e-6 ;
                  93.16877e-6 , -262.6542e-6 , 207050.7372e-6 ];
    I(:,:,2) = [ 32413.1852e-6,  20.2663e-6,  143.7579e-3;
                  20.2663e-6 , 21649.2574e-6, -38.6737e-6 ;
                  143.7579e-3,  -38.6737e-6, 25026.5101e-6 ];
    I(:,:,3) = [ 138575.0448e-6, 16890.4832e-6 ,    -6.5293e-6 ;
                16890.4832e-6 ,  5749.2209e-6,  -7.1669e-6 ;
                  -6.5293e-6  ,  -7.1669e-6 , 141310.5180e-6 ];
    I(:,:,4) = [  35752.4193e-6, -14.5876e-6 , -62.1491e-6 ;
                  -14.5876e-6 ,  35769.9341-6,  -29.2508e-6 ;
                -62.1491e-6 , 29.2508e-6 ,  2.9213314e-6 ];
    I(:,:,5) = [ 567.9724e-6,-0.4416e-6  , 0.0045e-6 ;
                -0.4416e-6 ,  172.3759e-6, -0.8172e-6 ;
                0.0045e-6, -0.8172e-6,  597.6265e-6 ];
    I(:,:,6) =  [ 979.8079e-6 ,  -0.2804e-6 , 0.5308e-6 ;
                   -0.2804e-6,  550.3998e-6, -225.3322e-6 ;
                  0.5308e-6, -225.3322e-6,  602.4224e-6 ];
  
        I(:,:,7) = [4536.8120e-6 , 0.00000019, -2.8944e-6  ;      % WAM without hand
                0, 4537.0156e-6, 0.00000000 ;
                -2.8944e-6  , 0.00000000, 42.1994e-6 ];   
     
    
    com = zeros(3,7);
    com(:,1) = [0.3506e-3; 132.6795e-3; 0.6286e-3];
    com(:,2) = [-0.2230e-3; -21.3924e-3; 13.3754e-3];
    com(:,3) = [-38.7565e-3; 217.9078e-3; 0.0252e-3];
    com(:,4) = [0.0062895;0.0000010;0.11063];
    com(:,5) = [0.00005483;0.02886286;0.00148493];
    com(:,6) = [-0.00005923;-0.07007252;-0.00335185];
    com(:,7) = [ 0.00014836;0.00007252;-0.00335185];
     
        
    
    I = zeros(3,3,7);
     
            
   
             T = zeros(4,4,7);
                E = zeros(7,7,7);
   D = zeros(7,7);
             
for j=1:7,
        a = DH_a(j);
        d = DH_d(j);
        alpha = DH_alpha(j);
        T(:,:,j) = getTransformDH(a, d, alpha, q(j));
end 
A = zeros(4,4,7);
A(:,:,1) = T(:,:,1);
A(:,:,2) = A(:,:,1)*T(:,:,2);
A(:,:,3) = A(:,:,2)*T(:,:,3);
A(:,:,4) = A(:,:,3)*T(:,:,4);
A(:,:,5) = A(:,:,4)*T(:,:,5);
A(:,:,6) = A(:,:,5)*T(:,:,6);
A(:,:,7) = A(:,:,6)*T(:,:,7);

R = zeros(4,4,7,7);
for i=1:7,
    for p=1:7,
        if i <= p
            if i == 1,  
                R(:,:,p,i)= A(:,:,p);
            else 
 
            b=i-1;
            
            R(:,:,p,i)= A(:,:,b)\A(:,:,p);
            end 
        else 
         end 
    end 
end 
Dx = zeros(3,7,7);
Dy = zeros(3,7,7);
Dz = zeros(3,7,7);
Dstar = zeros(3,7,7);
sigma = zeros(3,7,7);
   for i=1:7,
       for j=1:7,
           p=max(i,j);
           for x = p:7
Dx(i,x) = -R(1,1,x,i)*R(2,4,x,i) + R(2,1,x,i)*R(1,4,x,i); 
Dy(i,x) = -R(1,2,x,i)*R(2,4,x,i) + R(2,2,x,i)*R(1,4,x,i);
Dz(i,x) = -R(1,3,x,i)*R(2,4,x,i) + R(2,3,x,i)*R(1,4,x,i);
Dstar(:,i,x) = [Dx(i,x); Dy(i,x) ; Dz(i,x)];
sigma(:,i,x) = [R(3,1,x,i);R(3,2,x,i);R(3,3,x,i)];

Dxd(j,x) = -R(1,1,x,j)*R(2,4,x,j) + R(2,1,x,j)*R(1,4,x,j); 
Dyd(j,x) = -R(1,2,x,j)*R(2,4,x,j) + R(2,2,x,j)*R(1,4,x,j);
Dzd(j,x) = -R(1,3,x,j)*R(2,4,x,j) + R(2,3,x,j)*R(1,4,x,j);
Dstard(:,j,x) = [Dxd(j,x); Dyd(j,x) ; Dzd(j,x)];
sigmad(:,j,x) = [R(3,1,x,j);R(3,2,x,j);R(3,3,x,j)];
 E(i,j,x) = transpose(sigma(:,i,x))*I(:,:,x)*sigmad(:,j,x) + m(x)*(dot(Dstar(:,i,x),Dstard(:,j,x)) + dot(com(:,x),(cross(Dstar(:,i,x),sigmad(:,j,x)) + cross(Dstard(:,j,x),sigma(:,i,x)))));
           end 
   D(i,j)=  E(i,j,1)+  E(i,j,2)+  E(i,j,3)+  E(i,j,4)+ E(i,j,5)+  E(i,j,6)+  E(i,j,7);
       end 
   end

  
   grav = zeros(7,4);
   for i=1:7,
       if i==1 
           grav(i,:)= [0,0,-9.81,0];
       else 
   grav(i,:) =  [0,0,-9.81,0]*A(i-1)*[0,-1,0,0;1,0,0,0;0,0,0,0;0,0,0,0];
       end 
   end 
   comstar = zeros(4,7);
    comstar(:,1) = [0.3506e-3; 132.6795e-3; 0.6286e-3;1];
    comstar(:,2) = [-0.2230e-3; -21.3924e-3; 13.3754e-3;1];
    comstar(:,3) = [-38.7565e-3; 217.9078e-3; 0.0252e-3;1];
    comstar(:,4) = [0.00553408;0.00006822;0.11927695;1];
    comstar(:,5) = [0.00005483;0.02886286;0.00148493;1];
    comstar(:,6) = [-0.00005923;-0.01686123;0.02419052;1];
    comstar(:,7) = [ com(:,7);1];
   h = zeros(4,7);
   hstar = zeros(4,7);
   G = zeros(1,7);
   for i=1:7, 
      for p=i:7,
          if i==1 
          h(:,p)=m(p)*A(:,:,p)*comstar(:,p);    
          else
              h(:,p)=m(p)*inv(A(:,:,i-1))*A(:,:,p)*comstar(:,p);
          end
      end
      hstar(:,i) = sum(h,2);
      G(i) = grav(i,:)*hstar(:,i);
   end 
   
   
xd = [qd;-inv(D)*transpose(G)] + [zeros(7,7);inv(D)]*tau;
x= xd*0.002 + [q;qd];

end        
             
 function T = getTransformDH(a,d,alpha,q)
    ct = cos(q);
    st = sin(q);
    cb = cos(alpha);
    sb = sin(alpha);
    
    T = [ ct, -st*cb,  st*sb, a*ct;
          st,  ct*cb, -ct*sb, a*st;
          0, sb, cb, d;
          0, 0, 0, 1 ];            
 end       